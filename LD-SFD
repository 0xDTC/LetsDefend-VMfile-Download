#!/bin/bash

# Determine if the remote machine is Windows or Linux
read -p "Is the remote machine Windows or Linux? (w/l): " MACHINE_TYPE
if [[ "$MACHINE_TYPE" == "w" || "$MACHINE_TYPE" == "W" ]]; then
    read -p "Enter the remote server IP address: " REMOTE_HOST
    read -p "Enter the remote server username: " REMOTE_USER
    read -s -p "Enter the RDP password: " RDP_PASSWORD
    echo
    read -p "Enter the drive name (e.g., 'C:\,D:\,E:\'): " DRIVE_NAME
    read -p "Enter the local destination directory for the drive (e.g., /home/kali/letsdefend): " LOCAL_DESTINATION

    # Start RDP session using xfreerdp
    xfreerdp /v:"$REMOTE_HOST" /u:"$REMOTE_USER" /p:"$RDP_PASSWORD" /drive:"$DRIVE_NAME","$LOCAL_DESTINATION" +clipboard
    exit 0
fi

# If Linux, continue with SSH and SCP file transfer process
read -p "Enter the remote server username: " REMOTE_USER
read -p "Enter the remote server IP address: " REMOTE_HOST
echo "Enter the paths of the files on the remote server, separated by spaces:"
read -a REMOTE_FILES  # Read multiple file paths into an array
read -s -p "Enter the password for sudo access on the remote server: " ROOT_PASSWORD
echo
read -p "Enter the destination directory on the local machine (e.g., /home/kali/letsdefend): " LOCAL_DESTINATION

# Ensure the local destination directory exists
mkdir -p "$LOCAL_DESTINATION"

# Function to handle single file transfer
transfer_file() {
    local REMOTE_FILE=$1
    local TEMP_FILE="/home/$REMOTE_USER/temp_copy_$(basename "$REMOTE_FILE")"

    # Use expect to handle SSH and SCP interactions
    expect <<EOF
      # Step 1: SSH into the remote server, switch to root, copy the file, and adjust permissions
      log_user 0
      spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -t $REMOTE_USER@$REMOTE_HOST
      expect "password:"
      send "$ROOT_PASSWORD\r"
      expect "$ "
      send "sudo su -c 'cp $REMOTE_FILE $TEMP_FILE && chmod 644 $TEMP_FILE' > /dev/null 2>&1\r"
      expect "# "
      send "exit\r"

      # Step 2: SCP the file from the remote server to the local machine
      log_user 1
      spawn scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $REMOTE_USER@$REMOTE_HOST:$TEMP_FILE $LOCAL_DESTINATION
      expect "password:"
      send "$ROOT_PASSWORD\r"
      expect eof
EOF

    # Check if the file was successfully downloaded
    if [ ! -f "$LOCAL_DESTINATION/$(basename "$TEMP_FILE")" ]; then
        echo "Error: Failed to download $REMOTE_FILE."
    else
        echo "Successfully downloaded $REMOTE_FILE to $LOCAL_DESTINATION."
    fi

    # Clean up the temporary file on the remote server
    expect <<EOF
      log_user 0
      spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -t $REMOTE_USER@$REMOTE_HOST
      expect "password:"
      send "$ROOT_PASSWORD\r"
      expect "$ "
      send "sudo su -c 'rm $TEMP_FILE' > /dev/null 2>&1\r"
      expect "# "
      send "exit\r"
EOF
}

# Process each file by calling transfer_file function
for REMOTE_FILE in "${REMOTE_FILES[@]}"; do
    transfer_file "$REMOTE_FILE"
done

echo "All requested files have been processed."